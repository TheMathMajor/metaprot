<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Upload file</title>

    <link href="/css/lib/bootstrap.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/bootstrap-treeview.css" />
    <link rel="stylesheet" type="text/css" href="/css/temp.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <!-- Required Stylesheets -->
    <!--<link href="/css/lib/bootstrap.css" rel="stylesheet"/>-->

    <!-- Required Javascript -->

</head>
<body>


    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle toggle-left hidden-md hidden-lg" data-toggle="sidebar" data-target=".sidebar-left">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <img src="/img/icon11.png" height="40" width="100" align="middle" style="margin-top:5px;"/>
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="./about">About</a></li>
                    <li><a href="./contact">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar sidebar-left sidebar-animate sidebar-md-show">
                <ul class="nav nav-sidebar ">
                    <li class="active"><a href="#">Upload Data<span class="sr-only">(current)</span></a></li>
                    <li><a href="/upload-pass" class="preprocess">Preprocessing</a></li>
                    <li><a href="/analysis">Analysis</a></li>
                    <li><a href="">Annotation</a></li>
                    <li><a href="">Integration</a></li>
                    <li><a href="">Summary</a></li>
                </ul>
            </div>
            <div class="col-sm-6 col-sm-offset-3 col-md-7 col-md-offset-2 main">

                <h2>Upload a file</h2>
                <div class="well well-lg">
                    <form id="csv-upload-form" class="form-horizontal">
                        <fieldset>

                            <label for="fileInput">
                                <p>Select file:</p>
                            </label>
                            <input id="fileInput" type="file" class="form-control" required="required" />

                            <br/>

                            <label for="xAxisSelector">What do rows define in the input file?</label>
                            <select id="xAxisSelector">
                                <option value="Metabolite">Protein/Metabolite</option>
                                <option value="Time-Series">Time Point Data</option>
                            </select>

                            <br />

                            <label for="yAxisSelector">What do columns define in the input file?</label>
                            <select id="yAxisSelector">
                                <option value="Time-Series">Time Point Data</option>
                                <option value="Metabolite">Protein/Metabolite</option>
                            </select>

                            <br />

                            <input type="submit" value="Submit" class="form-control" />
                            <input type="reset" value="Reset" class="form-control" />

                        </fieldset>
                    </form>
                </div>
                <div id="progress-bar-display" class="transition transparent">
                    <h5>Upload Progress</h5>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0% Complete
                        </div>
                    </div>
                    <div id="progressText" class="text-center"></div><br />
                </div>
                <div class="footer">
                    <img src="img/nih_icon_2.svg" width="50"/>
                    &copy; 2017  BD2K MetProt is supported by the NIH Big Data to Knowledge award U54 GM114833.
                </div>
                <!--<div class="footer">Â© 2017 BD2K MetProt is supported by the NIH Big Data to Knowledge award U54 GM114833.</div>-->

            </div>
            <div class="col-sm-3 col-md-3" id="sidebar_right">
                <div id="top_part">
                    <div id="treeview" />
                </div>
                <div id = "bottom_part"/>
            </div>
        </div>
    </div>

    <!--<div th:include="fragments/footer :: footer"></div>-->

    <script type="text/javascript" src="/js/lib/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="/js/lib/bootstrap.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.4.12.min.js"></script>
    <script type="text/javascript" src="/js/aws/S3Uploader.js"></script>
    <script src="js/lib/jquery.js"></script>
    <script src="js/bootstrap-treeview.js"></script>
    <script src="js/sidebar.js"></script>
    <script type="text/javascript">
        /*<![CDATA[*/
        function buildDomTree() {

            console.log("buildDomTreeFunction");

            var data = [];

            function walk(nodes, data) {
                $.each(nodes, function (id,node) {2
                    //name
                    if (node["name"])
                    {
//                        console.log(node["name"]);
                        var obj = {
                            id: id,
                            text: node["name"],
//                            href: "./contact"
                        };
                        data.push(obj);
                    }
                    //children
                    if(node["children"])
                    {
                        if(node["children"].length>0)
                        {
                            obj.nodes = [];
                            walk(node["children"], obj.nodes);
                        }
                    }
                });
            }

            var tree = JSON.parse(sessionStorage.getItem("root"));
            walk(tree, data);
            console.log("data",data)
            return data;
        }


        $(function() {
            console.log("buildDomTree1");

            //file tree
            var options = {
//                backColor: '#cbd2d6',
//                onhoverColor: '#cbd2d6',
                highlightSelected: false,
                showBorder: false,
//                enableLinks: true,
                data: buildDomTree()
            };

            $('#treeview').treeview(options);
        });

        function modifyText(filename) {
            console.log("filename",filename);
        }

        function passFilenames(filename){
//            $(function() {
            console.log("buildDomTree2");

            //file tree
            var options = {
//                backColor: '#cbd2d6',
//                onhoverColor: '#cbd2d6',
                highlightSelected: false,
                showBorder: false,
//                enableLinks: true,
                data: buildDomTree()
            };

            $('#treeview').treeview(options);

            var el = document.getElementById(filename);
            console.log("el", el);
//            el.addEventListener("click", function () {modifyText(filename)});
            el.addEventListener('click', function () {
                console.log("alert:filename",filename);
            } );

//            document.getElementById("treeview").addEventListener("click",function(e) {
//                // e.target is our targetted element.
//                // try doing console.log(e.target.nodeName), it will result LI
//                if(e.target && e.target.nodeName == "LI") {
//                    console.log(e.target.id + " was clicked");
//                }
//            });
        }


        $(function() {

            var $progressBar = $('.progress-bar');
            var $fileInput = $('#fileInput');

            function updateProgressBar(progress) {
                $progressBar.html(progress + "% complete");
                $progressBar.css("width", progress+"%");
            }

            // when all files are uploaded, tell server to check for integrity
            function notifyAllFilesUploaded(token, s3Key) {
                var $progressText = $('#progressText');
//                var $fileText = $('#fileText');
                $progressText.html('<h5>Checking integrity...</h5><i class="fa fa-refresh fa-spin fa-3x"></i>');

                var formData = new FormData();
                formData.append("objectKey", s3Key);
                formData.append("token", token);
                // TODO abineet, if you want more info from the client, you can grab it from the HTML and
                // formData.append() it.

                // notify server of file upload and updates UI to reflect status
                $.ajax({
                    url: '/analyze/integrity-check',
                    method: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success:function(data) {    // really just prints on screen any response from server
                        var s = data.toString();
                        $progressText.html('<div class="alert alert-success">' + s + '</div>');
//                        $('#preprocess').html(onclick="window.location.href='/upload'");

                    },
                    error:function(jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                        console.log(textStatus);
                        console.log(errorThrown);
                        $progressText.html('<div class="alert alert-danger">' + jqXHR.responseJSON.message + '</div>');
//                        $fileText.html('filex');
                    }
                });
            }

            $('#csv-upload-form').on("submit", function(e) {
                e.preventDefault();

                // upload w/ token
                // number of files to upload, for now, just handle 1
                var numFiles = $fileInput[0].files.length;
                var numFilesUploaded = 0;

                if (!numFiles) {
                    return;
                }

                $('#progress-bar-display').css("opacity", 1);

                var afterEachFileRead = function(options) {
                    console.log("A file is ready to upload.");
                    //var toPush = options.name + ",";
                    var toPush = [{name: options.name, children: []}];
                    var b = {name: options.name, children: []};
                    if (sessionStorage.getItem("root") === null) {
                        sessionStorage.setItem("root", JSON.stringify(toPush));
                    }
                    else{
                        var curr = JSON.parse(sessionStorage.getItem("root"));
                        curr.push(b);
                        sessionStorage.setItem("root", JSON.stringify(curr));
                        console.log(JSON.stringify(curr));
                    }
                    var delayCounter = 0;

                    var moreParams = {
                        ContentLength : options.size,
                        ContentType : options.type
                    };

                    // get token for s3 upload
                    $.ajax({
                        url: "/analyze/token",
                        method: "GET",
                        success:function(token) {
                            // after retrieving a token, can upload to s3
                            S3Uploader.upload(options.data, "user-input/" + token + "/" + options.name, moreParams,
                                function(data) {
                                    numFilesUploaded++;
                                    if (numFilesUploaded == numFiles) {
                                        // we are done uploading!
                                        console.log("all files have been uploaded to s3");
                                        updateProgressBar(100);

                                        notifyAllFilesUploaded(token, data.Key);
                                        $(function() {
                                            passFilenames(options.name);
                                        });

//                                        console.log("buildDomTree2");
//
//                                        var option = {
//                                            //                                backColor: '#cbd2d6',
//                                            //                                onhoverColor: '#cbd2d6',
//                                            highlightSelected: false,
//                                            showBorder: false,
//                                            //                                enableLinks: true,
//                                            data: buildDomTree()
//                                        };
//
//                                        $('#treeview').treeview(option);
//
//                                        console.log("options", options);
//                                        console.log("options.name", options.name);
////                                        console.log("options.data", options.data);
////                                        console.log("options.data[0]", options.data[0]);
//                                        var el = document.getElementById(options.name);
//                                        console.log("el", el);
//                                        el.addEventListener("click", function () {modifyText(options.name)});

                                    }
                                },
                                function(key, bytesUploaded, bytesTotal) {
                                    // called whenever bytes transferred to s3, with performance delay
                                    delayCounter++;
                                    if (delayCounter == 10) {
                                        updateProgressBar(bytesUploaded/bytesTotal*100);
                                    }
                                });
                    },
                        error:function() {
                            console.log("Error in retrieving upload token.");
                        }
                    });

                };

                // set up FC and read in files
                FileController.setOnFileRead(afterEachFileRead);
                FileController.setInputElement($fileInput);
                FileController.readFiles();



            });
        });


        /*]]>*/
    </script>

</body>
</html>

