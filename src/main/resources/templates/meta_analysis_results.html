<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text='${"Results for " + token + " | Metaprot"}'></title>
    <link rel="stylesheet" type="text/css" href="/css/lib/bootstrap.simplex.min.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Arimo" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/1.2.2/css/buttons.dataTables.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
</head>
<body>
    <div th:include="fragments/header :: header"></div>

    <div class="container results">
        <div class="row text-center">
            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h2 class="panel-title" th:text='${"Results for task: " + token}'></h2>
                    </div>
                    <div class="panel-body">
                        <div>
                            Volcano plot
                            <div id="d3-plot"></div>
                            <!--<img th:src='${"/metabolite-analysis/results/image/" + token + "/volcano.png"}' />-->
                        </div>
                        <div th:switch="${results.size()}">
                            <div th:case="0">No results</div>
                            <div th:case="*">
                                <table class="table table-striped table-bordered table-hover" id="results-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>P Value</th>
                                            <th>FDR</th>
                                            <th>Fold Change</th>
                                            <th>Significance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="result : ${results}">
                                            <td th:text="${result.getIndex()}"></td>
                                            <td th:text="${result.getpValue()}"></td>
                                            <td th:text="${result.getFdr()}"></td>
                                            <td th:text="${result.getFoldChange()}"></td>
                                            <td th:text="${result.getSignificance()}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        Footer
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="/js/lib/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="/js/lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="//cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script type="text/javascript" th:inline="javascript">
        $(function(){
            var $resultsTable = $('#results-table');
            $resultsTable.DataTable({
                "dom": 'Bfrtip',
                "paging": true,
                "bFilter": false,
                "buttons":['csv', 'excel']
            });

            // convert raw table data to matrix for d3
            var results = [[${results}]];
            var dataset = [];
            for (var index in results) {
                var result = results[index];
                dataset.push([Math.log2(result.foldChange), -1*Math.log10(result.pValue)]);
            }

            // plot dimensions
            var height = 400;
            var width = 500;
            var padding = 20;   // just to prevent colliding elements

            // scale functions (for better visualization of small values)
            var minX = d3.min(dataset, function(d) { return d[0]});
            var maxX = d3.max(dataset, function(d) { return d[0]});
            var minY = d3.min(dataset, function(d) { return d[1]});
            var maxY = d3.max(dataset, function(d) { return d[1]});

            console.log("minX " + minX)
            console.log("maxX" + maxX)
            console.log("minY " + minY)
            console.log("maxY" + maxY);

            var xScale = d3.scaleLinear()   // range of X values (preserve x values with width)
                    .domain([minX, maxX])
                    .range([0, width]);

            var yScale = d3.scaleLinear()   // ^
                    .domain([minY, maxY])
                    .range([height-padding, padding]);  // flips the growth of y values from downward to upwards

            // generate x and y axes
            var xAxis = d3.axisBottom()
                    .scale(xScale);

            var yAxis = d3.axisLeft()
                    .scale(yScale);

            // zoom feature
            //var zoom = d3.zoom().x(xScale).y(yScale).on("zoom", zoomed);

            var svg = d3.select("#d3-plot").text("D3 Plot").append("svg")
                    .attr("height", height)
                    .attr("width", width);
            svg.selectAll("circle")
                    .data(dataset)
                    .enter()
                    .append("circle")           // tag name
                    .attr("class", "d3-node")   // class name
                    .attr("cx", function(d) {
                        return xScale(d[0]);
                    })
                    .attr("cy", function(d) {
                        return yScale(d[1]);
                    })
                    .attr("r", 2)
                    .style("fill", function(d) {
                        if (d[0] > 0.75) {
                            return "red";
                        } else {
                            return "black";
                        }
                    });

            // append axes
            svg.append("g").attr("class", "axis").attr("transform", "translate(0, " + (height-padding) + ")").call(xAxis);
            svg.append("g").attr("class", "axis").call(yAxis);

            // enable zoom
            //svg.call(zoom);
        });
    </script>

    <div th:include="fragments/footer :: footer"></div>

</body>
</html>