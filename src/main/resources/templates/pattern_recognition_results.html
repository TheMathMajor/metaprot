<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${'TPR Results for task: ' + token + '| Metaprot'}"></title>
    <link rel="stylesheet" type="text/css" href="/css/lib/bootstrap.simplex.min.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Arimo" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
</head>
<body>
    <div th:include="fragments/header :: header"></div>

    <div class="container">
        <div class="row">
            <div class="panel panel-default">
                <div class="panel-heading" th:text="'Pattern Recognition Results for task:' + ${token}"></div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-7">
                            <div class="plot">
                                <svg id="visualisation">

                                </svg>
                            </div>
                        </div>
                        <div class="col-sm-5">
                            <h4>Clusters</h4>
                            <div class="well well-lg">
                                <form id="cluster-selection-form" class="form-horizontal">
                                    <div class="form-group">
                                        <label for="cluster-select" class="control-label">Select a cluster:</label>
                                        <select id="cluster-select" class="form-control">
                                            <option th:each="result, i : ${results}" th:text="${i.count}" th:value="${i.count - 1}"></option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="cluster-checkbox">Select all</label>
                                        <input type="checkbox" id="cluster-checkbox" />
                                    </div>
                                </form>
                            </div>
                            <div id="sidePanel" class="pattern-recognition"></div> <!-- rendered by SidePanel module -->
                        </div>
                    </div>
                </div>
                <div class="panel-footer">footer</div>
            </div>
        </div>
    </div>

    <div th:include="fragments/footer :: footer"></div>

    <script type="text/javascript" src="/js/lib/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="/js/lib/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="/js/PatternRecogPlot.js"></script>
    <script type="text/javascript">

        // sanitizes the input string for safe use as classNames, ids, etc.
        // update as needed
        // replaces: . " " , ; : with "-"
        function sanitizeForHtml(input) {
            input = input.trim();
            return input.replace(/\./g, "-")
                    .replace(/\s/g, "-")
                    .replace(/\:/g, "-")
                    .replace(/\;/g, "-")
                    .replace(/\,/g, "-");
        }

        /*<![CDATA[*/
        /**
         * Module for rendering SidePanel tables for pattern recognition analysis.
         *
         * @param data the input dataset in form : [ [ {metaboliteName:"", dataPoints:[ {'abundanceRatio':__, 'timePoint':__} ]}, ... ] ]
         * @param $sideTableContainer the containing JQ element that holds side tables (direct parent)
         * @type {Function}/Module
         */
        var SidePanel = (function(dataset, $sideTableContainer) {

            /**
             * Renders the side tables with the input data
             */
            var drawSideTables = function() {

                if ( !dataset || !(dataset.length > 0) || !(dataset[0].length > 0)) {
                    console.log("No data to draw sidetable.");
                    return;
                }

                // get the headings for the table by iterating through one of the dataPoints
                var headings = [];
                for (var i = 0; i < dataset[0][0]['dataPoints'].length; i++) {
                    headings.push(dataset[0][0]['dataPoints'][i].timePoint);
                }

                var tableWrapper = document.createElement("div");   // will hold all tables

                // for each cluster
                for (var i = 0; i < dataset.length; i++) {

                    // create a table for this cluster
                    var table = document.createElement("table");
                    table.classList.add("table", "table-hover");
                    table.setAttribute("data-cluster-id", i);
                    table.style.display = "none";

                    var tableHead = document.createElement("thead");
                    var tableBody = document.createElement("tbody");

                    // populate thead with headings
                    var tableRow = document.createElement("tr");
                    var thName = document.createElement("th");
                    thName.innerHTML = "Name";

                    tableRow.appendChild(thName);

                    // create rest of the headings
                    for (var j = 0; j < headings.length; j++) {
                        var thCurrent = document.createElement("th");
                        thCurrent.innerHTML = headings[j];

                        tableRow.appendChild(thCurrent);
                    }

                    // append the row of headings to thead
                    tableHead.appendChild(tableRow);

                    // for each metabolite in cluster
                    for (var j = 0; j < dataset[i].length; j++) {

                        // create a new row; append a td element with the metabolite name
                        var rowCurr = document.createElement("tr");
                        rowCurr.setAttribute("data-cluster-position", j);
                        rowCurr.classList.add(sanitizeForHtml(dataset[i][j]['metaboliteName']), "data-row");

                        var tDataName = document.createElement("td");
                        tDataName.innerHTML = dataset[i][j]['metaboliteName'];

                        rowCurr.appendChild(tDataName);

                        // for each temporal datapoint of this metabolite
                        for (var k = 0; k < dataset[i][j]['dataPoints'].length; k++) {
                            var tData = document.createElement("td");
                            tData.innerHTML = dataset[i][j]['dataPoints'][k]['abundanceRatio'].toFixed(3);

                            rowCurr.appendChild(tData);
                        }

                        tableBody.appendChild(rowCurr);
                    }

                    // add table to wrapper
                    table.appendChild(tableHead);
                    table.appendChild(tableBody);
                    tableWrapper.appendChild(table);
                }

                // finally, add all tables to the sideTableContainer
                $sideTableContainer[0].appendChild(tableWrapper);

            };

            /**
             * Given a cluster id, displays the table for that cluster (while hiding
             * all other tables).
             *
             * @param clusterId the numeric, zero-based cluster id
             */
            var displayTable = function(clusterId) {
                $("#" + $sideTableContainer.attr("id") + " table").css("display", "none");
                $('table[data-cluster-id="' + clusterId +'"]').css("display", "block");
            };

            return {
                drawSideTables : drawSideTables,
                displayTable : displayTable
            };
        });

        /*]]>*/ /* because of XML parsing */
    </script>
    <script th:inline="javascript" type="text/javascript">


        // results of the task
        var results = [[${results}]];

        //Initialize plot
        var plot = new PatternRecogPlot(results);

        plot.InitChart();

        // render side panels using results, and bind necessary events
        var sidePanel = new SidePanel(results, $('#sidePanel'));
        sidePanel.drawSideTables();
        sidePanel.displayTable(0);
        $('#cluster-select').on("change", function() {
            sidePanel.displayTable(+$(this).val());
        });
        $('#sidePanel table tr').on("click", function() {
            $(this).toggleClass("active");

            var clusterId = +$(this).parents('table').attr('data-cluster-id');
            var input = {};

            input.i = clusterId;
            input.j = +$(this).attr('data-cluster-position');
            input.update = $(this).hasClass("active");

            // some function([input])
            console.log(input)
            plot.updateChart([input]);
        });
        $('#cluster-checkbox').on("change", function(e) {

            // get the cluster Id of the currently active cluster and the associated rows
            var activeClusterId = +$('#cluster-select').val();
            var $clusterRows = $('table[data-cluster-id="'+ activeClusterId + '"] tr.data-row');

            // array of updates to pass into drawing function
            var elementsToChange = [];
            var update = null;
            var addToArray = function() {
                var obj = {};
                obj.i = activeClusterId;
                obj.j = +$(this).attr('data-cluster-position');
                obj.update = update;

                elementsToChange.push(obj);
            };

            if (e.target.checked) {
                update = true;  // means to draw the lines
                $clusterRows.each(addToArray);
                $clusterRows.addClass("active");
            } else {
                update = false;
                $clusterRows.each(addToArray);
                $clusterRows.removeClass("active");
            }

            // call some function to draw selected elements
            console.log(elementsToChange);
            plot.updateChart(elementsToChange);

        });

    </script>

</body>

</html>